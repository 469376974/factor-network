/*!
 * factor-network.js v1.0.0
 * (c) 2017-04-05 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function r(t){return Math.max(0,t)}function o(t){return t<=0?0:1}function e(t){return 1/(1+Math.exp(-t/1))}function u(t){return t*(1-t)}function a(t){if(t===1/0)return 1;if(t===-(1/0))return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function i(t){return 1-t*t}function f(n){for(var r=[],o=n[0],e=1;e<n.length;e++){for(var u=[],a=0;a<n[e];a++){for(var i=[],f=0;f<o;f++){var c=t();i.push(c)}u.push(i)}o=u.length,r.push(u)}return r}function c(t,n,r){for(var o=n,e=[n.concat()],u=0;u<t.length;u++){for(var a=t[u],i=[],f=0;f<a.length;f++){for(var c=a[f],v=0,h=0;h<c.length;h++){var p=c[h];v+=o[h]*p}var s=m[r||"SIGMOID"].output(v);i.push(s)}e.push(i),o=i}return e}function v(t,n){for(var r=0;r<t.length;r++)for(var o=t[r],e=0;e<o.length;e++)for(var u=o[e],a=0;a<u.length;a++){var i=u[a];n({weight:i,node:u,layer:o,network:t,path:[r,e,a]})}}function h(t){return JSON.parse(JSON.stringify(t))}function p(t,n){for(var r=[n.concat()],o=n,e=t.length-2;e>=0;e--){for(var u=t[e],a=t[e+1],i=[],f=u.length-1;f>=0;f--){for(var c=0,v=a.length-1;v>=0;v--){var h=a[v][f];c+=o[v]*h}i.unshift(c)}r.unshift(i),o=i}return r}function s(t,n,r,o,e){v(t,function(u){var a=u.path,i=t[a[0]][a[1]][a[2]],f=n[a[0]][a[2]],c=n[a[0]+1][a[1]],v=r[a[0]][a[1]],h=-e*v*f*m[o].derivative(c),p=i+h;t[a[0]][a[1]][a[2]]=p})}function l(t){function n(){return u}function r(n){return a=c(u,n,t.activation||"SIGMOID")}function o(t){for(var n=[],r=a[a.length-1],o=0;o<t.length;o++){var e=r[o]-t[o];n.push(e)}return p(u,n)}function e(n){var r=o(n);s(u,a,r,t.activation||"SIGMOID",t.learningRate)}var u=f(t.network),a=null;return{options:t,getNetwork:n,compute:r,adjust:e}}function d(r,o,e){return v(r,function(u){var a=u.path;if(n()){var i=o[a[0]][a[1]][a[2]];r[a[0]][a[1]][a[2]]=i}Math.random()<=e.rate&&(r[a[0]][a[1]][a[2]]+=e.range*t())}),r}function g(t){function n(){return i}function r(n,r){return c(i[n],r,t.activation||"SIGMOID")}function o(t,n){s.push({score:n,network:i[t]})}function e(){s=[]}function u(t){s.sort(function(n,r){return t>0?n.score-r.score:r.score-n.score})}function a(){if(s.length===t.amount){u(t.sortType);for(var n=[],r=Math.round(t.elitismRate*t.amount),o=0;o<r;o++)n.push(s[o].network);for(var e=Math.round(t.randomRate*t.amount),a=0;a<e;a++)n.push(f(t.network));for(var c=0;;){for(var v=0;v<c;v++)for(var p=0;p<t.mixNumber;p++){var l=d(h(s[v].network),s[c].network,t.mutation);if(n.push(l),n.length===t.amount)return s=[],void(i=n)}c++}}}for(var i=[],v=0;v<t.amount;v++){var p=f(t.network);i.push(p)}var s=[];return{getNetworks:n,options:t,compute:r,addItem:o,clearAll:e,adjust:a}}var m={RELU:{output:r,derivative:o},SIGMOID:{output:e,derivative:u},TANH:{output:a,derivative:i}};return{network:Object.freeze({create:f,compute:c,walk:v,copy:h}),backPropagation:l,evolution:g}});