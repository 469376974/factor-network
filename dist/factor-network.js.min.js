/*!
 * factor-network.js v1.0.0
 * (c) 2017-04-04 Jade Gu
 * Released under the MIT License.
 * @license
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.FactorNetwork=n()}(this,function(){"use strict";function t(){return 2*Math.random()-1}function n(){return Math.random()<=.5}function r(t){return Math.max(0,t)}function o(t){return t<=0?0:1}function e(t){return 1/(1+Math.exp(-t/1))}function u(t){var n=e(t);return n*(1-n)}function a(t){if(t===1/0)return 1;if(t===-1/0)return-1;var n=Math.exp(2*t);return(n-1)/(n+1)}function i(t){var n=a(t);return 1-n*n}function f(n){for(var r=[],o=n[0],e=1;e<n.length;e++){for(var u=[],a=0;a<n[e];a++){for(var i=[],f=0;f<o;f++){var c=t();i.push(c)}u.push(i)}o=u.length,r.push(u)}return r}function c(t,n,r){for(var o=n,e=[n.concat()],u=0;u<t.length;u++){for(var a=t[u],i=[],f=0;f<a.length;f++){for(var c=a[f],v=0,h=0;h<c.length;h++){var s=c[h];v+=o[h]*s}var p=m[r].output(v);i.push(p)}e.push(i),o=i}return e}function v(t,n){for(var r=0;r<t.length;r++)for(var o=t[r],e=0;e<o.length;e++)for(var u=o[e],a=0;a<u.length;a++){var i=u[a];n({weight:i,node:u,layer:o,network:t,path:[r,e,a]})}}function h(t){return JSON.parse(JSON.stringify(t))}function s(t,n){for(var r=[n.concat()],o=n,e=t.length-1;e<=0;e--){for(var u=t[e],a=[],i=u.length-1;i<=0;i--){for(var f=u[e],c=[],v=f.length-1;v<=0;v--){var h=f[v],s=o[i]*h;c.unshift(s)}a.unshift(c),o=c}r.unshift(a)}return r}function p(t,n,r,o,e){v(t,function(u){var a=u.path,i=t[a[0]][a[1]][a[2]],f=n[a[0]][a[1]],c=n[a[0]+1][a[1]],v=r[a[0]][a[1]],h=i+e*v*f*m[o].derivative(c);t[a[0]][a[1]][a[2]]=h})}function l(t){function n(){return e}function r(t){return u=c(e)}function o(n){for(var r=[],o=u[u.length-1],i=0;i<n.length;i++){var f=n[i]-o[i];r.push(f)}a=s(e,r),p(e,u,a,t.activation,t.learningRate)}var e=f(t.network),u=null,a=null;return{options:t,getNetwork:n,compute:r,adjuest:o}}function d(r,o,e){return v(r,function(u){var a=u.path;if(n()){var i=o[a[0]][a[1]][a[2]];r[a[0]][a[1]][a[2]]=i}Math.random()<=e.rate&&(r[a[0]][a[1]][a[2]]+=e.range*t())}),r}function g(t){function n(){return i}function r(n,r){return c(i[n],r,t.activation||"SIGMOID")}function o(t,n){p.push({score:n,network:i[t]})}function e(){p=[]}function u(t){p.sort(function(n,r){return t>0?n.score-r.score:r.score-n.score})}function a(){if(p.length===t.amount){u(t.sortType);for(var n=[],r=Math.round(t.elitismRate*t.amount),o=0;o<r;o++)n.push(p[o].network);for(var e=Math.round(t.randomRate*t.amount),a=0;a<e;a++)n.push(f(t.network));for(var c=0;;){for(var v=0;v<c;v++)for(var s=0;s<t.mixNumber;s++){var l=d(h(p[v].network),p[c].network,t.mutation);if(n.push(l),n.length===t.amount)return p=[],void(i=n)}c++}}}for(var i=[],v=0;v<t.amount;v++){var s=f(t.network);i.push(s)}var p=[];return{getNetworks:n,options:t,compute:r,addItem:o,clearAll:e,adjust:a}}var m={RELU:{output:r,derivative:o},SIGMOID:{output:e,derivative:u},TANH:{output:a,derivative:i}};return{backPropagation:l,evolution:g}});